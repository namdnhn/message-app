<template>
  <div class="custom-background">
    <h1>Message</h1>
    <div class="select-platform-and-sender">
      <div class="select-box">
        <label>Platform: </label>
        <select class="custom-select" v-model="selectedPlatform" required>
          <option disabled selected value="">Choose one platform</option>
          <option
            v-for="platform in platforms"
            :key="platform.id"
            :value="platform"
          >
            {{ platform.name }}
          </option>
        </select>
      </div>

      <div class="select-box">
        <label> User: </label>
        <select class="custom-select" v-model="selectedSender" required>
          <option disabled selected value="">Choose one user</option>
          <option
            v-for="sender in filterSendersByPlatforms"
            :key="sender.id"
            :value="sender"
          >
            {{ sender.name }}
          </option>
        </select>
      </div>
    </div>

    <div class="receiver-url">
      <label><h4>URL:</h4></label>
      <textarea
        class="custom-textbox"
        v-model="urlReceiver"
        placeholder="Receiver's URL"
        required
      ></textarea>
    </div>

    <div class="message">
      <h4>Message</h4>
      <div class="select-template">
        <div class="item">
          <select
            class="custom-select"
            @change="onChange"
            :value="selectedTemplateId"
          >
            <option disabled selected value="">Choose one template</option>
            <option
              v-for="template in templates"
              :key="template.id"
              :value="template.id"
            >
              {{ template.name }}
            </option>
          </select>
        </div>

        <div class="item">
          <button class="create-template" @click="createAndEditTemplate">
            Create and Edit Template
          </button>
        </div>
      </div>
      <div class="place-holder">
        <label><h6>Placeholder</h6></label>
        <div class="place-holder-order">
          <button
            class="place-holder-button"
            v-for="option in placeholderOptions"
            :key="option.name"
            @click="addPlaceholder(option.text)"
          >
            {{ option.name }}
          </button>
        </div>
      </div>
      <div class="message-box">
        <textarea
          class="custom-textbox"
          v-model="message"
          placeholder="Message"
          required
        ></textarea>
      </div>
    </div>

    <h4>Target Settings</h4>
    <div class="checkbox-message">
      <label>
        <input type="checkbox" v-model="targetSettings.changedPosition" />
        {{ targetSettingsMessages.changedPosition }}
      </label>
      <label>
        <input type="checkbox" v-model="targetSettings.alreadyConnected" />
        {{ targetSettingsMessages.alreadyConnected }}
      </label>
      <label>
        <input type="checkbox" v-model="targetSettings.followCandidate" />
        {{ targetSettingsMessages.followCandidate }}
      </label>
    </div>

    <button @click="preview">Preview and Send</button>

    <div v-if="showPreviewModel" class="popup">
      <div class="popup-content">
        <span class="close" @click="closeModel">&times;</span>
        <h3>Preview</h3>
        <p>Platform: {{ previewData.platform }}</p>
        <p>Sender: {{ previewData.sender }}</p>
        <p>Receiver URL: {{ previewData.urlReceiver }}</p>
        <p>Message: {{ previewData.message }}</p>
        <p>Choosen target setting:</p>
        <li
          v-for="message in previewData.targetSettings"
          :key="message"
          :value="message"
        >
          {{ message }}
        </li>
        <button @click="send">Send</button>
      </div>
    </div>

    <div v-if="showCreateAndEditTemplate" class="popup">
      <div class="popup-content">
        <TabWrapper>
          <Tab title="Create">
            <span class="close" @click="closeTemplate">&times;</span>
            <h3>Create Template</h3>
            <li>Template name</li>
            <input v-model="newTemplateName" class="custom-input" />
            <li>Template content</li>
            <textarea
              v-model="newTemplateContent"
              class="custom-textbox-template-content"
            ></textarea>
            <div><button @click="saveTemplate">Save</button></div>
          </Tab>
          <Tab title="Edit">
            <span class="close" @click="closeTemplate">&times;</span>
            <h3>Edit Template</h3>
            <li>Choose Template</li>
            <select class="custom-select" v-model="selectedTemplateToEdit">
              <option
                v-for="template in templates"
                :key="template.id"
                :value="template"
              >
                {{ template.name }}
              </option>
            </select>
            <li>Template name</li>
            <input v-model="editTemplateName" class="custom-input" />
            <li>Template content</li>
            <textarea
              v-model="editTemplateContent"
              class="custom-textbox-template-content"
            ></textarea>
            <div><button @click="editTemplate">Save</button></div>
          </Tab>
        </TabWrapper>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import axios from "axios";
import { computed, onMounted, reactive, type Ref, ref, watch } from "vue";
import TabWrapper from "@/components/tab/TabWrapper.vue";
import Tab from "@/components/tab/Tab.vue";

const components = { Tab, TabWrapper };

// chọn platform
interface Platform {
  id: number;
  name: string;
}
const platforms = ref<Platform[]>();
onMounted(async () => {
  try {
    const response = await axios.get("http://localhost:8000/platforms");
    platforms.value = response.data;
  } catch (error) {
    console.error("Failed to fetch platforms:", error);
  }
});
const selectedPlatform = ref<Platform>();

// chọn sender
interface Sender {
  id: number;
  name: string;
  platform: number;
}

interface SendersData {
  [key: number]: Sender[];
}

const senders: Ref<SendersData> = ref({});

const selectedSender = ref<Sender>();

onMounted(async () => {
  try {
    const response = await axios.get("http://localhost:8000/senders");
    senders.value = response.data;
  } catch (error) {
    console.error("Failed to fetch senders:", error);
  }
});

const filterSendersByPlatforms = computed(() => {
  if (selectedPlatform.value) {
    return senders.value[selectedPlatform.value.id];
  } else {
    return [];
  }
});

// chọn template
interface Template {
  id: number;
  name: string;
  template: string;
}

const showCreateAndEditTemplate = ref(false);
const templates: Ref<Template[]> = ref([]);
onMounted(async () => {
  try {
    const response = await axios.get<Template[]>(
      "http://localhost:8000/templates"
    );
    templates.value = response.data;
  } catch (error) {
    console.error("Failed to fetch templates:", error);
  }
});

const selectedTemplateId: Ref<number> = ref(0);
const templateFilterById = computed(() => {
  return templates.value.find(
    (template) => template.id == selectedTemplateId.value
  );
});

const onChange = (event: { target: { value: number } }) => {
  selectedTemplateId.value = event.target.value;
  message.value = templateFilterById.value?.template || "";
};
const createAndEditTemplate = () => {
  showCreateAndEditTemplate.value = true;
};
const closeTemplate = () => {
  showCreateAndEditTemplate.value = false;
};

// create Template
const newTemplateName = ref("");
const newTemplateContent = ref("");
const saveTemplate = async () => {
  const newTemplate: Template = {
    id: 0,
    name: newTemplateName.value,
    template: newTemplateContent.value,
  };
  try {
    // Gọi API endpoint bằng Axios để gửi thông tin message
    const response = await axios.post(
      "http://localhost:8000/create-template/",
      newTemplate
    );
    console.log(response.data.message); // Hiển thị response từ backend
  } catch (error) {
    console.error("Failed to send message:", error);
  }
  newTemplateName.value = "";
  newTemplateContent.value = "";
  showCreateAndEditTemplate.value = false;
};

// edit Template
const editTemplateName = ref("");
const editTemplateContent = ref("");
const selectedTemplateToEdit: Ref<Template | undefined> = ref(undefined);

watch(selectedTemplateToEdit, (newValue, oldValue) => {
  console.log(newValue);
});
const editTemplate = async () => {
  const temp_id: number | undefined = selectedTemplateToEdit.value?.id;
  console.log(temp_id);
  if (temp_id != undefined) {
    const newTemplate: Template = {
      id: temp_id,
      name: editTemplateName.value,
      template: editTemplateContent.value,
    };
    try {
      // Gọi API endpoint bằng Axios để gửi thông tin message
      const response = await axios.put(
        "http://localhost:8000/edit-template/" + newTemplate.id,
        newTemplate
      );
      console.log(response.data.message); // Hiển thị response từ backend
    } catch (error) {
      console.error("Failed to send message:", error);
    }
    editTemplateName.value = "";
    editTemplateContent.value = "";
    showCreateAndEditTemplate.value = false;
  }
};

// nhập receiver URL và message
const placeholderOptions = [
  { name: "candidate", text: " #__CANDIDATE__# " },
  { name: "platform", text: " #__PLATFORM__# " },
  { name: "age", text: " #__AGE__# " },
];
const addPlaceholder = (text : string) => {
  message.value += text;
};
const urlReceiver = ref("");
const message: Ref<string> = ref("");

// box target setting
const targetSettings = reactive({
  changedPosition: false,
  alreadyConnected: false,
  followCandidate: false,
});
const targetSettingsMessages = {
  changedPosition:
    "Do not send message if current company or position is changed",
  alreadyConnected: "Do not send to people you've already connected with",
  followCandidate: "Follow candidate when sending invite message",
};

// check validate
const validateData = computed(() => {
  if (
    selectedSender.value != undefined &&
    selectedPlatform.value != undefined &&
    message.value != "" &&
    urlReceiver.value != ""
  ) {
    return true;
  } else {
    if (selectedPlatform.value == undefined)
      window.alert("Missing platform! Please choose a platform!");
    else if (selectedSender.value == undefined)
      window.alert("Missing sender! Please choose a sender!");
    else if (message.value == "")
      window.alert("Missing message! Please type the message!");
    else window.alert("Missing Receiver's URL. Please type URL");
    return false;
  }
});

// xem preview
interface PreviewData {
  platform: string;
  sender: string;
  urlReceiver: string;
  message: string;
  targetSettings: string[];
}

const previewData: Ref<PreviewData> = ref({
  platform: "",
  sender: "",
  urlReceiver: "",
  message: "",
  targetSettings: [],
});
const showPreviewModel = ref(false);
const preview = () => {
  if (validateData.value == true) {
    if (selectedPlatform.value)
      previewData.value.platform = selectedPlatform.value.name;
    else previewData.value.platform = "Nothing";
    if (selectedSender.value)
      previewData.value.sender = selectedSender.value.name;
    else previewData.value.sender = "Nothing";
    if (urlReceiver.value == "") previewData.value.urlReceiver = "Nothing";
    else previewData.value.urlReceiver = urlReceiver.value;

    previewData.value.message = message.value;

    if (
      !targetSettings.alreadyConnected &&
      !targetSettings.changedPosition &&
      !targetSettings.followCandidate
    ) {
      previewData.value.targetSettings.push("Not selected");
    } else {
      if (targetSettings.alreadyConnected) {
        previewData.value.targetSettings.push(
          targetSettingsMessages.alreadyConnected
        );
      }
      if (targetSettings.changedPosition) {
        previewData.value.targetSettings.push(
          targetSettingsMessages.changedPosition
        );
      }
      if (targetSettings.followCandidate) {
        previewData.value.targetSettings.push(
          targetSettingsMessages.followCandidate
        );
      }
    }
    showPreviewModel.value = true;
  } else {
    console.warn("Nô");
  }
};
const closeModel = () => {
  previewData.value.targetSettings.splice(
    0,
    previewData.value.targetSettings.length
  );
  showPreviewModel.value = false;
};

// post
interface Message {
  platform: number | undefined;
  receiver: number | undefined;
  urlReceiver: string;
  messageContent: string;
  alreadyConnected: boolean;
  changePosition: boolean;
  followCandidate: boolean;
}

const send = async () => {
  const sendMessage: Message = {
    platform: selectedPlatform.value?.id,
    receiver: selectedSender.value?.id,
    urlReceiver: urlReceiver.value,
    messageContent: message.value,
    alreadyConnected: targetSettings.alreadyConnected,
    changePosition: targetSettings.changedPosition,
    followCandidate: targetSettings.followCandidate,
  };

  try {
    // Gọi API endpoint bằng Axios để gửi thông tin message
    const response = await axios.post(
      "http://localhost:8000/send-message/",
      sendMessage
    );
    console.log(response.data.message); // Hiển thị response từ backend
  } catch (error) {
    console.error("Failed to send message:", error);
  }

  // Đặt giá trị các biến về mặc định sau khi gửi
  selectedPlatform.value = undefined;
  selectedSender.value = undefined;
  urlReceiver.value = "";
  selectedTemplateId.value = 0;
  message.value = "";
  targetSettings.alreadyConnected = false;
  targetSettings.changedPosition = false;
  targetSettings.followCandidate = false;
  previewData.value.targetSettings.splice(
    0,
    previewData.value.targetSettings.length
  );
  showPreviewModel.value = false;
};
</script>

<style>
.checkbox-message {
  display: flex;
  flex-direction: column;
}

.custom-input {
  width: 40%;
}

.custom-textbox {
  resize: none;
  width: 90%;
  height: 100px;
}

.custom-textbox-template-content {
  resize: none;
  width: 90%;
  height: 120px;
}

.message {
  margin-top: 10px;
  margin-bottom: 10px;
}

::placeholder {
  color: #999;
}

.receiver-url {
  display: flex;
  flex-direction: column;
  margin-top: 10px;
  margin-bottom: 10px;
}

.select-platform-and-sender {
  display: flex;
  margin-top: 10px;
  margin-bottom: 10px;
}

.select-platform-and-sender .custom-select {
  width: 60%;
  height: 30px;
}

.select-template {
  display: flex;
  margin-top: 10px;
  margin-bottom: 10px;
}

.select-template .item {
  flex: 1;
}

.select-template .custom-select {
  width: 60%;
  height: 30px;
}

.select-template .create-template {
  height: 30px;
  align-items: center;
  display: flex;
}

.select-box {
  width: 50%;
  display: flex;
  flex-direction: column;
}

.popup {
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Màu nền xám mờ */
  z-index: 9999;
}

.popup-content {
  width: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

.close {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
  cursor: pointer;
}

.place-holder {
  margin-bottom: 15px;
}

.place-holder-button {
  margin-right: 20px;
  border-radius: 5px;
  transition-duration: 0.4s;
}

.place-holder-button:hover {
  background-color: black;
  color: white;
}

h3 {
  margin-top: 0;
}

p {
  margin: 5px 0;
}

ul {
  list-style: none;
  padding: 0;
  margin: 5px 0;
}

li {
  margin: 3px 0;
}
</style>
